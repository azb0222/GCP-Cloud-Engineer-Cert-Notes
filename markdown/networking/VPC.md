# VPC 

## Overview
- VPCs (+ associated routes and firewall rules) are global resources, not associated with any one region or zone.
- Each project comes with a default VPC, with subnets created in each region w/ non overlapping CIDR blocks (CIDR blocks are associated with each subnet) 
- Firewall rules can control traffic flow in and out of VPC
- Only IPv4 traffic within a VPC is supported
- Resources within the same VPC can communicate automatically using internal IP addresses, even if placed across different regions 

## Types of VPC Networks
1. **Auto Mode VPC/Automode Network**: 
   - Pre-configured VPC with default subnets within each region with predetermined IP range w/ a /20 CIDR block (can be expanded upto /16) 
   - With new regions, GCP automatically adds more subnets in new regions.
   - Command to create:
     ```bash
     gcloud compute networks create test-vpc --subnet-mode=auto
     ```
   
2. **Custom Mode VPC Network**: 
   - Better suited for production, more fine-grained control
     - can't use auto mode networks for inter-VPC connectivity (ie. VPC Network Peering/Cloud VPN due to overlapping IP ranges)
     - auto-created new subnets in new regions can overlap with existing manually created IP addresses 
   - Users manually specify subnets in specific regions, specifying IP ranges. Start with NO subnets, can create more than one subnet per region. If you modify an auto-mode VPC to custom mode, the autogenerated subnets still remain
   - Can switch from auto to custom.
   - Command to create:
     ```bash
     gcloud compute networks create test-vpc --subnet-mode=custom
     ```

## Subnets
- **subnets**: regional resources. Each subnet is associated with a range of IP addresses.
- Subnetwork primary/secondary IP ranges cannot overlap with any other ranges in the same or connected VPC 
- Command to create a subnet:
  ```bash
  gcloud beta compute networks subnets create test-subnet --network=test-vpc --region=us-west2 --range=10.10.0.0/16 --enable-private-ip-google-access --enable-flow-logs
  ```
- Command to describe subnets: 
  ```bash 
  gcloud compute networks subnets describe default --region=us-west1
  ```
- Secondary IP ranges within a subnet allow for additional network segmentation, to have multiple distinct IP ranges within one subnet. Cannot overlap with primary 
- Can increase subnet primary/secondary IP range as long as there is no overlap
- 4 reserved IP addresses in every subnet's primary IP range: 
  - 1) Network address (first address)
  - 2) Default Gateway (second address)
  - 3) GCP future use (second to last address)
  - 4) Broadcast (last address)
- you can have multiple subnets in a region 

### Private Google Access 
- Allows for VMs in a subnet to reach external IP addresses of Google APIs/services using internal IP addresses instead of external IP addresses, keeping all traffic within Google's internal network only
- Command to enable on a subnet: 
  ```bash
    gcloud compute networks subnets update SUBNET_NAME \
    --region REGION \
    --enable-private-ip-google-access
  ```
- can also use internal IPs only on On-Prem network through Cloud VPN tunnel, VPC Peering connection, etc. without needing to assign extneral IPs <TODO: didn't understand>

## VPC Routes
- **route**: define network traffic path take by a VM instance to another destination
- Each route consists of: 
  - single destination (CIDR block): range of IP addresses that the route is applied to
  - single next hop: target to which traffic is forward to when it matches the destination ie. default IGW, VM instance, IP address, VPN tunnel, internal TCP/UDP load balancer, etc.  
  - priority (to determine routing order for a packet): from 0-65535
- routes are stored in VPC routing table (all VM instances are updated with the routing table)  
- A default route comes with every VPC, allows traffic from VPC instances to make outbound connections to the internet via the default GCP Internet Gateway 
- Each packet that leaves a VM is delivered to the next hop of an applicable route based on a routing order
  - routing order is calculated based on longest CIDR prefix match ("most specific/narrow match"), then route priority

### Routing Types
1) System Generated
- Every VPC will come with two system-generated routes: 
  - 1) Default: path to Internet, path for Private Google Access (can delete). lower priority of 1000 
  - 2) Subnet Route: corresponding within each primary, secondary, etc. IP range within each subnet; the destination matches the primary IP range of the subnet. allow for traffic flow between different subnets within the VPC, so all instances can communicate. higher priority of 0 
    - lifecycle if subnet route is dependent upon lifecycle of subnet 
2) Custom Routes: Custom route destinations cannot overlap with any subnet route. Used to control traffic flow ie. through firewall, VPN tunnel, etc. 
- 1) Static Routes: use the next hop feature. can narrow based on network tags  
- 2) Dynamic Routes: managed by Cloud Routers, allow for dynamic exchange of routes between VPC and on-prem network. 
  - destination IP ranges are OUTSIDE of VPC network 
  - next hops are BGP peered addresses 
  - used with dynamically routed Cloud VPNs and Cloud Interconnect
3) Special Routes: defined in Google's Production Network, don't appear in VPC routing table. cannot override, delete, or replace. Use firewall rules to customize traffic. used with GCP Load Balancers, IAP, Cloud DNS 

## IP Addressing 
- Used by VMs, load balancers, NAT Gateways, VPN Gateways, GKE, etc.
Options: 
- IP Address
  - Internal (Private) 
    - Auto (from Auto Mode)
      - Ephemeral: released when resource is deleted, can be reassigned; can be automatically assigned from subnet. can promote to static (default behaviour)
      - Static: reserve from subnet's internal IP range, takes it out of dynamic allocation pool (must RESERVE a static external IP address) 
    - Custom (from Custom Mode)
      - Ephemeral
      - Static
    - Alias IP ranges: pulled form subnet's primary or secondary ranges. configure multiple internal IP addresses to represent containers/applications hosted in a VM without using a separate network interface 
  - External (Public): communicate with resources in another network, internet, or public GCP service
    - Ephemeral: same as Internal Ephemeral, however is also released when VM instance is stopped 
    - Static: can be associated with regional (ie. regional Load Balancer) AND global resources (ie. global Load Balancer).
      - 1) Regional IP address: `gcloud compute addresses create ADDRESS_NAME --region REGION`
      - 2) Global IP address: `gcloud compute addresses create ADDRESS_NAME --global --ip-version [IPV4 | IPV6]` 
- default behaviour for a VM in GCP: an ephemeral internal IP address + an OPTIONAL external IP address

## Forwarding Rules
<TODO: what is a forwarding rule in GCP? in ChatGPT>

## Firewall Rules

---




## Connectivity Methods for Interproject Traffic
- **Shared VPC**
- **VPC Peering**
- **Private Service Connect (PSC)**

## Private Google Access
- Allows VMs on a subnet to access Google Services without assigning an external IP address.

## Dynamic Routing within VPC
- The routing tables within VPC will be updated depending on your chosen routing mode:
  1. **Regional Routing**: 
     - Google Cloud routers are restricted to learning routes within a region.
     - Traffic between subnets across multiple regions must go through the public internet unless connected via peering, VPN, etc.
     - Good for data compliance, etc.
  2. **Global Routing**: 
     - Learn routes to route traffic between subnets in different regions within GCP's private network (default).

## CIDR Notation
- CIDR: IP address/prefix length.
- Example: Prefix length /25 corresponds to subnet mask of 255.255.255.0.
- Subnet mask determines which part is network vs. host: network-hosts.

## Shared VPC
only avail for orgs
connect resources from multiple projects to a common VPC network 
will have: 
    - host project: continas one more more shared VPC networks. Shared VPC admin enables project as host project. host project can share its resources (ie. networsk, subnets, secondary address range, etc.) with the service projects 
    - service projects: project attached to host project by shared vpc admin. resources service projects can talk to each other via shared VPC  
- Can also create a shared VPC (hosted in one common project) within an organization. Users with enough permissions can create resources in that VPC.
- Shared VPC command: 
  ```bash
  gcloud compute shared-vpc

 shared VPC admins can delegate further roles ie. creating/managing instances to Service Project Admins, network admin tasks to Network and Security Admins 
- Create IAM policy binding, assign org member: shared VPC admin role (`roles/compute.xpnAdmin`) and resourcemanager.projectIamAdmin role at organization/folder level.
- Shared VPCs can be shared at different levels: organization (entire org), folder level (all projects within a folder), project level.
